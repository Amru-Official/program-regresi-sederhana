<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Regression Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
        }
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .alert-fixed {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: none;
        }
        .result-card {
            transition: all 0.3s ease;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .conclusion {
            font-weight: 500;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }
        .conclusion-positive {
            background-color: #d4edda;
            color: #155724;
        }
        .conclusion-negative {
            background-color: #f8d7da;
            color: #721c24;
        }
        .conclusion-warning {
            background-color: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2 text-center">Menghitung regresi...</div>
        </div>
    </div>

    <!-- Alert Notifications -->
    <div id="alertNotification" class="alert alert-fixed" role="alert"></div>

    <div class="container mt-5 mb-5">
        <h1 class="text-center mb-4">Data Regresi Linier Sederhana</h1>
        
        <!-- Form Input Data -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Input Data</h5>
                    </div>
                    <div class="card-body">
                        <form id="dataForm" action="/add" method="post">
                            <input type="hidden" id="data_id" name="data_id">
                            <div class="mb-3">
                                <label for="independent_variable" class="form-label">Variabel Independen (X)</label>
                                <input type="number" step="any" class="form-control" id="independent_variable" name="independent_variable" required>
                            </div>
                            <div class="mb-3">
                                <label for="dependent_variable" class="form-label">Variabel Dependen (Y)</label>
                                <input type="number" step="any" class="form-control" id="dependent_variable" name="dependent_variable" required>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Simpan</button>
                                <button type="reset" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <!-- Tabel Data -->
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Data Tersimpan</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>X</th>
                                        <th>Y</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% result.forEach(data => { %>
                                        <tr>
                                            <td><%= data.data_id %></td>
                                            <td><%= data.independent_variable %></td>
                                            <td><%= data.dependent_variable %></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-warning" onclick="fillForm('<%= data.data_id %>', '<%= data.independent_variable %>', '<%= data.dependent_variable %>')">
                                                        <i class="bi bi-pencil"></i> Edit
                                                    </button>
                                                    <form action="/delete" method="post" class="d-inline" onsubmit="return confirm('Apakah Anda yakin ingin menghapus data ini?');">
                                                        <input type="hidden" name="data_id" value="<%= data.data_id %>">
                                                        <button type="submit" class="btn btn-danger">
                                                            <i class="bi bi-trash"></i> Hapus
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tombol Hitung Regresi -->
        <div class="text-center mb-4">
            <button id="calculateRegression" class="btn btn-lg btn-primary">
                <i class="bi bi-calculator"></i> Hitung Regresi
            </button>
        </div>

        <!-- Hasil Regresi -->
        <div id="regressionResult" class="d-none">
            <h2 class="text-center mb-4">Hasil Analisis Regresi Linear</h2>
            
            <!-- Persamaan Regresi dan Statistik Dasar -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card result-card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">Persamaan Regresi</h5>
                        </div>
                        <div class="card-body">
                            <p id="equation" class="h4 text-center mb-0"></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card result-card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">Statistik Dasar</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">RÂ² (Koefisien Determinasi): <span id="rSquared" class="fw-bold"></span></p>
                            <p class="mb-0">Jumlah data (n): <span id="nPoints" class="fw-bold"></span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Uji Asumsi Klasik -->
            <h3 class="text-center mb-4">Hasil Uji Asumsi Klasik</h3>
            <div class="row">
                <!-- Normalitas -->
                <div class="col-md-4">
                    <div class="card result-card shadow-sm h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">Uji Normalitas</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">Statistik KS: <span id="ksStatistic" class="fw-bold"></span></p>
                            <p class="mb-2">P-Value: <span id="ksPValue" class="fw-bold"></span></p>
                            <div id="normalityConclusion" class="conclusion"></div>
                        </div>
                    </div>
                </div>

                <!-- Heteroskedastisitas -->
                <div class="col-md-4">
                    <div class="card result-card shadow-sm h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">Uji Heteroskedastisitas</h5>
                        </div>
                        <div class="card-body" id="heteroscedasticityContent">
                            <p class="mb-2">Statistik BP: <span id="bpStatistic" class="fw-bold"></span></p>
                            <p class="mb-2">P-Value: <span id="bpPValue" class="fw-bold"></span></p>
                            <div id="heteroscedasticityConclusion" class="conclusion"></div>
                        </div>
                    </div>
                </div>

                <!-- Autokorelasi -->
                <div class="col-md-4">
                    <div class="card result-card shadow-sm h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">Uji Autokorelasi</h5>
                        </div>
                        <div class="card-body" id="autocorrelationContent">
                            <p class="mb-2">Statistik DW: <span id="dwStatistic" class="fw-bold"></span></p>
                            <div id="dwInterpretation" class="conclusion"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to show alert
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alertNotification');
            alert.className = `alert alert-${type} alert-fixed`;
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Function to fill form for editing
        function fillForm(id, independent, dependent) {
            document.getElementById('data_id').value = id;
            document.getElementById('independent_variable').value = independent;
            document.getElementById('dependent_variable').value = dependent;
            document.getElementById('dataForm').action = '/update';
        }

        // Function to reset form
        function resetForm() {
            document.getElementById('data_id').value = '';
            document.getElementById('dataForm').action = '/add';
        }

        // Function to show loading spinner
        function showLoading() {
            document.querySelector('.loading').style.display = 'block';
        }

        // Function to hide loading spinner
        function hideLoading() {
            document.querySelector('.loading').style.display = 'none';
        }

        // Function to update regression results
        function updateRegressionResults(data) {
            // Show results container
            document.getElementById('regressionResult').classList.remove('d-none');

            // Update basic regression results
            document.getElementById('equation').textContent = data.equation;
            document.getElementById('rSquared').textContent = `${(data.rSquared * 100).toFixed(2)}%`;
            document.getElementById('nPoints').textContent = data.n;

            // Update normality test results
            const normalityConclusion = document.getElementById('normalityConclusion');
            document.getElementById('ksStatistic').textContent = data.normalityTest.statistic;
            document.getElementById('ksPValue').textContent = data.normalityTest.pValue;
            normalityConclusion.textContent = data.normalityTest.isNormal ? 
                'Residual berdistribusi normal' : 
                'Residual tidak berdistribusi normal';
            normalityConclusion.className = `conclusion ${data.normalityTest.isNormal ? 'conclusion-positive' : 'conclusion-negative'}`;

            // Update heteroscedasticity test results
            const heteroContent = document.getElementById('heteroscedasticityContent');
            if (data.heteroscedasticityTest.skipped) {
                heteroContent.innerHTML = `<div class="conclusion conclusion-warning">${data.heteroscedasticityTest.reason}</div>`;
            } else {
                document.getElementById('bpStatistic').textContent = data.heteroscedasticityTest.statistic;
                document.getElementById('bpPValue').textContent = data.heteroscedasticityTest.pValue;
                const heteroConclusion = document.getElementById('heteroscedasticityConclusion');
                heteroConclusion.textContent = data.heteroscedasticityTest.isHomoscedastic ?
                    'Tidak ada heteroskedastisitas' :
                    'Terdapat heteroskedastisitas';
                heteroConclusion.className = `conclusion ${data.heteroscedasticityTest.isHomoscedastic ? 'conclusion-positive' : 'conclusion-negative'}`;
            }

            // Update autocorrelation test results
            const autoContent = document.getElementById('autocorrelationContent');
            if (data.autocorrelationTest.skipped) {
                autoContent.innerHTML = `<div class="conclusion conclusion-warning">${data.autocorrelationTest.reason}</div>`;
            } else {
                document.getElementById('dwStatistic').textContent = data.autocorrelationTest.statistic;
                const dwInterpretation = document.getElementById('dwInterpretation');
                dwInterpretation.textContent = data.autocorrelationTest.interpretation;
                dwInterpretation.className = 'conclusion conclusion-warning';
            }
        }

        // Event listener for calculate regression button
        document.getElementById('calculateRegression').addEventListener('click', function() {
            showLoading();

            fetch('/calculate-regression')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.error) {
                        showAlert(data.error, 'danger');
                    } else {
                        updateRegressionResults(data);
                        showAlert('Perhitungan regresi berhasil!', 'success');
                    }
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Terjadi kesalahan saat menghitung regresi: ' + error.message, 'danger');
                });
        });
    </script>